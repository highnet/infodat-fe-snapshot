/* @copyright Stadt Wien - Wiener Melange 200 */
import{s as t}from"../../lit-element-8d7b5fe2.js";import{x as r}from"../../lit-html-34d0b6a8.js";import{dispatchCustomEvent as e}from"../misc/utils.js";import{FormControlRegistry as o}from"../misc/form-control-registry.js";import{FormValidationController as i}from"../misc/form-validation-controller.js";import"../../unsafe-html-4e49b66a.js";import"../../directive-16e189ed.js";import"../misc/error-tracking.js";class s extends t{get _form(){return this.querySelector("form")??null}get _fields(){return this.querySelectorAll("wm-input, wm-select, wm-textarea, wm-radio, wm-upload, wm-checkbox, wm-switch, wm-form-group, input, select, textarea")??[]}static properties={validate:{type:Boolean},hideMaxlength:{type:Boolean},hasValidationError:{type:Boolean,reflect:!0}};constructor(){super(),this.validate=!1,this.hideMaxlength=!1,this.hasValidationError=!1,this._formControlRegistry=new o,this._validationController=new i(this,this._formControlRegistry)}connectedCallback(){super.connectedCallback()}firstUpdated(){Promise.resolve().then((()=>{this._form?(this._form.setAttribute("novalidate","novalidate"),this._registerFormControls(),this._setGlobalFormOptions(),this._onSubmit(),this._onReset()):console.error("Form element not found")}))}_registerFormControls(){this._fields&&this._fields.forEach((t=>{t&&(this._formControlRegistry.register(t),"wm-form-group"===t.tagName.toLowerCase()&&(t.addEventListener("control-added",(t=>{t.detail&&t.detail.control&&(this._formControlRegistry.register(t.detail.control),this._applyGlobalFormOptions(t.detail.control))})),t.addEventListener("control-removed",(t=>{t.detail&&t.detail.control&&this._formControlRegistry.unregister(t.detail.control)}))))}))}_onSubmit(){this._form&&this._form.addEventListener("submit",(t=>{this._form.setAttribute("data-submitting","");const r=this.querySelector("wm-formerrorsummary");r&&(r.innerHTML="",r.setAttribute("hidden","")),this._validationController.reset(!1),this._fields&&this._fields.forEach((t=>{t&&"showErrors"in t&&(t.showErrors=!0)}));if(this._checkValidity()){const t=this.querySelector("wm-formerrorsummary");t&&(t.innerHTML="",t.setAttribute("hidden",""))}else t.preventDefault(),this._handleErrors(),e(this,"form-invalid",{errors:this._validationController.errors});this._form&&this._form.removeAttribute("data-submitting")}))}_onReset(){this._form&&this._form.addEventListener("reset",(t=>{t.preventDefault(),this._errors=[],this._errorSummary&&this._errorSummary.setAttribute("hidden","hidden"),this.hasValidationError=!1,this._formControlRegistry.resetAll(),e(this,"form-reset",{timestamp:(new Date).toISOString()}),this.updateComplete.then((()=>{e(this,"form-reset-complete",{timestamp:(new Date).toISOString()})}))}))}_checkValidity(){const t=this._validationController.validate();return this.hasValidationError=!t,t}_handleErrors(){try{const t=this._validationController.errors;this.hasValidationError=t.length>0,e(this,"validation-state-changed",{hasErrors:this.hasValidationError,errorCount:t.length,errors:[...t]}),this.updateComplete.then((()=>{let r=this.querySelector("wm-formerrorsummary");if(!r){r=document.createElement("wm-formerrorsummary");const t=this._form;t?this.insertBefore(r,t):this.prepend(r)}if(t.length>0?(r.innerHTML="",t.forEach((t=>{const e=document.createElement("li"),o=document.createElement("a");o.href=`#${t.id}`,o.textContent=t.summaryMsg||t.msg,e.appendChild(o),r.appendChild(e)})),r.removeAttribute("hidden")):r.setAttribute("hidden",""),1===t.length&&t[0].id){const r=this.querySelector(`#${t[0].id}`);r&&"function"==typeof r.focus&&r.focus()}}))}catch(t){console.error("Error handling form errors:",t)}}_setGlobalFormOptions(){this._fields&&this._fields.forEach((t=>{t&&(this.validate&&(t.setAttribute("validate",""),"showErrors"in t&&(t.showErrors=!1),"_hasInteracted"in t&&(t._hasInteracted=!1)),this.hideMaxlength&&["INPUT","WM-INPUT","TEXTAREA","WM-TEXTAREA"].includes(t.nodeName)&&t.setAttribute("hideMaxlength",!0))}))}setErrors(t){this._validationController.setErrors(t),this._handleErrors()}getErrors(){return this._validationController.getErrors()}createRenderRoot(){return this}render(){return r`<slot></slot>`}}customElements.define("wm-form",s);const n="wm-form";export{s as Form,n as tagName};
