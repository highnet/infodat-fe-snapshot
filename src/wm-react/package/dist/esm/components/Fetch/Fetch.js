/* @copyright Stadt Wien - Wiener Melange 200 */
import{s as t}from"../../lit-element-8d7b5fe2.js";import{x as e}from"../../lit-html-34d0b6a8.js";import{_stringToObject as s,getFocusableChildren as i}from"../misc/utils.js";import"../../unsafe-html-4e49b66a.js";import"../../directive-16e189ed.js";class a extends t{static properties={json:{type:String},url:{type:String},dataset:{type:String},pagination:{type:String,reflect:!0},itemsPerPage:{type:Number,reflect:!0},total:{type:Number,reflect:!0},_offset:{type:Number},_itemsPerSet:{type:Number},_results:{type:Array},_debug:{type:Boolean}};get _pagination(){return this.querySelector("wm-pagination")??null}get _content(){return this.querySelector("[data-fetch-content]")??null}get _attributes(){return this.querySelectorAll("[data-fetch-attributes]")??null}get _template(){return this.querySelector("template")??null}get _table(){return this.querySelector("wm-table")??null}constructor(){super(),this.json="",this.url="",this.dataset=void 0,this._results="",this.itemsPerPage=5,this._itemsPerSet=this.itemsPerPage,this._offset=0,this.pagination=void 0,this.total=0,this._debug=!1}createRenderRoot(){return this}updated(t){t.has("itemsPerPage")&&(this._itemsPerSet=this.itemsPerPage),t.has("url")&&this.url&&this._fetchData(),t.has("json")&&this.json&&this._fetchData()}_fetchData(){this.json&&this._processData(JSON.parse(this.json)),this.url&&fetch(this.url).then((t=>t.json())).then((t=>{this._processData(t)}))}_processData(t){this._pagination&&this._reset(),this._results=this.dataset?t[this.dataset]:t,this._displayData(!0),this.total=this._results.length,this._debug&&console.log(this._results),this.dispatchEvent(new CustomEvent("wm-fetched",{detail:this._results.length,bubbles:!0,composed:!0})),this._overrideSortingInTables()}async _overrideSortingInTables(){this._table&&(await this._table.updateComplete,setTimeout((()=>{this._table.addEventListener("click",(t=>{if(t.target.closest("[data-sort]")&&t.target.closest("[data-fetch-sort-property]")){const e=t.target.closest("[data-fetch-sort-property]").dataset.fetchSortProperty,s=t.target.closest("[data-sort]").dataset.sort;this._results=this._results.sort(((t,i)=>{console.log(s);const a="1"===s?t[e]:i[e],r="1"===s?i[e]:t[e];return a.localeCompare(r,void 0,{numeric:!0,sensitivity:"base"})})),this._reset(),this._displayData()}}))}),0))}_reset(){setTimeout((()=>{this._pagination.reset()}),0),this._offset=0,this._itemsPerSet=this.itemsPerPage}_displayData(){if(this._content){this._content.innerHTML="";for(let t=this._offset;t<this._itemsPerSet;t++){const e=this._results[t];if(e){const t=this._template.content.cloneNode(!0).children[0],i=t.querySelectorAll("[data-fetch-field]");for(let t=0;t<i.length;t++){const a=i[t];a.innerHTML=s(a.dataset.fetchField,e)}const a=t.querySelectorAll("[data-fetch-condition]");for(let t=0;t<a.length;t++){const i=a[t],r=i.dataset.fetchCondition.split(":");s(r[1],e)!==r[0]&&i.remove()}this._replaceAttributes(t.querySelectorAll("*"),e),this._content.appendChild(t)}}}else this._attributes&&this._replaceAttributes(this._attributes,this._results[0])}_replaceAttributes(t,e){for(let i=0;i<t.length;i++){const a=t[i];for(const t in a.dataset)if(-1!==t.indexOf("fetchAttribute")&&"fetchAttributes"!==t&&a.dataset[t]){const i=a.dataset[t].split(":");a.setAttribute(i[0],s(i[1],e)),delete a.dataset[t]}}}_loadMore(){this._itemsPerSet=this._itemsPerSet+this.itemsPerPage,this._displayData()}async setJSON(t){await this.updateComplete;let e=t;"string"==typeof t&&(e=JSON.parse(t)),this._processData(e)}connectedCallback(){super.connectedCallback()}firstUpdated(){this._pagination&&this._pagination.addEventListener("wm-page-changed",(t=>{this._offset=this.itemsPerPage*(t.detail.currentPage-1),this._itemsPerSet=this.itemsPerPage*t.detail.currentPage,this._displayData(),i(this._content).length&&i(this._content)[0].focus()})),this.dispatchEvent(new CustomEvent("wm-defined",{detail:{},bubbles:!0,composed:!0}))}render(){return e`
			<wm-stack vertical gap="xs">
				<div><slot></slot></div>

				${"number"===this.pagination?e`
							<wm-pagination
								total="${this.total}"
								perPage="${this.itemsPerPage}"
								maxpages="6"
								justify="center"
								?hidden="${this.itemsPerPage>this._results.length}"
								firstAndLast
							></wm-pagination>
					  `:""}
				${"button"===this.pagination&&this._itemsPerSet<this._results.length?e` <wm-button @click="${this._loadMore}">
							<button>Mehr laden</button>
					  </wm-button>`:""}
			</wm-stack>
		`}}customElements.define("wm-fetch",a);const r="wm-fetch";export{a as Fetch,r as tagName};
