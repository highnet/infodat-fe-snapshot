/* @copyright Stadt Wien - Wiener Melange 200 */
import{s as e}from"../../lit-element-8d7b5fe2.js";import{x as t}from"../../lit-html-34d0b6a8.js";import{FormText as s}from"../misc/form-text.js";import{f as i}from"../../form-item.styles-b671e7a9.js";import{f as l}from"../../form.styles-3cb5bbeb.js";import{o as r}from"../../if-defined-d257cee1.js";import{debounce as a,dispatchCustomEvent as h}from"../misc/utils.js";import{FormStateManager as n}from"../misc/form-state-manager.js";import{ErrorStateController as o}from"../misc/error-state-controller.js";import{g as u}from"../../wiener-melange.bundle.min-ae18d627.js";import"../misc/form-item.js";import"../../when-741bb8d9.js";import"../../class-map-b15037ef.js";import"../../directive-16e189ed.js";import"../../unsafe-html-4e49b66a.js";import"../misc/form-wrapper.js";import"../misc/slot.js";import"../misc/error-tracking.js";import"../misc/formValidation.js";import"../misc/shared-info.js";const c=new CSSStyleSheet;c.replaceSync(u);class d extends(n(s(e))){static properties={...super.properties,multiple:{type:Boolean},size:{type:Number},type:{type:String,reflect:!0},disabled:{type:Boolean,reflect:!0},errormessage:{type:String,attribute:"errormessage"},summaryErrormessage:{type:String,attribute:"summary-errormessage"},hasError:{type:Boolean,reflect:!0},error:{type:String},options:{type:String},values:{type:String},selected:{type:String,reflect:!0},validate:{type:Boolean,reflect:!0},showErrors:{type:Boolean,reflect:!0},_parsedOptions:{state:!0},_optionsCache:{state:!0},_lastOptionsSignature:{state:!0},_debounceTimer:{state:!0},_initialSelectedValues:{state:!0},disabledoptions:{type:String}};static styles=[c,i,l];constructor(){super(),this.size=void 0,this.multiple=!1,this.type="select",this.disabled=!1,this.errormessage="",this.summaryErrormessage="",this.hasError=!1,this.error="",this.validate=!1,this.showErrors=!1,this.options="",this.values="",this.selected="",this.disabledoptions="",this._parsedOptions=[],this.value=this.multiple?[]:"",this._optionsCache={},this._lastOptionsSignature="",this._debouncedDispatchChange=a((e=>{h(this,"change",{value:e})}),200),this._initialSelectedValues=this.multiple?[]:"",this._errorController=new o(this)}get _selectElement(){return this.shadowRoot?.querySelector("select")??null}async connectedCallback(){if(super.connectedCallback(),this.hasAttribute("disabledoptions")&&(this.disabledoptions=this.getAttribute("disabledoptions")),this.hasAttribute("selected")){const e=this.getAttribute("selected");this.multiple?this._initialSelectedValues=e?e.split(";").map((e=>e.trim())):[]:this._initialSelectedValues=e||""}if(this._parseOptionsFromAttributes(),await Promise.resolve(),this._selectElement){const e=()=>{this._selectElement.addEventListener("invalid",(t=>{t.preventDefault();const s=this.errormessage||"Bitte wÃ¤hlen Sie eine Option aus";this._errorController.setError(s),setTimeout((()=>e()),0)}),{once:!0})};e(),this._selectElement.addEventListener("input",(()=>{(this.validate||this.showErrors)&&this.checkValidity()}))}}_getOptionsSignature(){return`${this.options||""}::${this.values||""}`}_parseDisabledOptions(){if(this.hasAttribute("disabledoptions")){const e=this.getAttribute("disabledoptions");if(e)return e.split(";").map((e=>"true"===e.trim().toLowerCase()))}return[]}_parseOptionsFromAttributes(){const e=this._getOptionsSignature();if(e===this._lastOptionsSignature&&this._parsedOptions.length>0)return;if(this._optionsCache[e])return this._parsedOptions=this._optionsCache[e].map((e=>e.cloneNode(!0))),void(this._lastOptionsSignature=e);const t=this.options?this.options.split(";").map((e=>e.trim())):[],s=this.values?this.values.split(";").map((e=>e.trim())):[],i=this.selected?this.selected.split(";").map((e=>e.trim())):[],l=this._parseDisabledOptions(),r=this.id||`select-${Math.random().toString(36).substring(2,9)}`,a=Math.max(t.length,s.length),h=[];let n=!1;for(let e=0;e<a;e++){const r=document.createElement("option");e<s.length&&s[e]?r.value=s[e]:e<t.length&&(r.value=t[e]),r.textContent=e<t.length?t[e]:r.value,this.disabled?r.disabled=!0:e<l.length&&(r.disabled=l[e]),this.multiple?i.includes(r.value)&&(r.selected=!0,n=!0):i.length>0&&r.value===i[0]&&(r.selected=!0,n=!0),h.push(r)}if(this._optionsCache[e]=h.map((e=>e.cloneNode(!0))),this._lastOptionsSignature=e,this._parsedOptions=h,i.length>0){if(n||console.warn(`Select ${r}: None of the selected values ${JSON.stringify(i)} match available options`),this.multiple){const e=i.filter((e=>s.includes(e)));this._initialSelectedValues&&Array.isArray(this._initialSelectedValues)&&this._initialSelectedValues.length||(this._initialSelectedValues=[...e]),this.value=[...e]}else{const e=s.includes(i[0])?i[0]:"";this._initialSelectedValues||""===this._initialSelectedValues||(this._initialSelectedValues=e),this.value=e}this.required&&this.clearErrorState()}else this.multiple?this.value=[]:this.value=""}_updateSelectWithParsedOptions(){if(!this._selectElement)return;if(!this._parsedOptions.length)return;const e=Array.from(this._selectElement.options||[]);if(!(e.length!==this._parsedOptions.length||e.some(((e,t)=>e.value!==this._parsedOptions[t].value||e.textContent!==this._parsedOptions[t].textContent))))return this._updateValueState(),void this._updateFormValue();this._selectElement.innerHTML="";const t=document.createDocumentFragment();if(this._parsedOptions.forEach((e=>t.appendChild(e.cloneNode(!0)))),this._selectElement.appendChild(t),this.multiple&&Array.isArray(this.value)){Array.from(this._selectElement.options).forEach((e=>{e.selected=this.value.includes(e.value)}))}else this.value&&(this._selectElement.value=this.value);if(this._updateValueState(),this._updateFormValue(),this.value)if(this.multiple&&Array.isArray(this.value)){const e=Array.from(this._selectElement.options);let t=!1;e.forEach((e=>{const s=this.value.includes(e.value);e.selected!==s&&(e.selected=s,t=!0)})),t&&this._selectElement.dispatchEvent(new Event("change",{bubbles:!0}))}else this._selectElement.value!==this.value&&(this._selectElement.value=this.value,this._selectElement.dispatchEvent(new Event("change",{bubbles:!0})))}updateOptions(e){const t=this._selectElement;if(!t)return;if(this._parsedOptions&&this._parsedOptions.length>0)return void this._updateSelectWithParsedOptions();if(!Array.isArray(e))return;t.innerHTML="";const s=document.createDocumentFragment();e.forEach((e=>{e instanceof HTMLOptionElement&&s.appendChild(e.cloneNode(!0))})),t.appendChild(s),this._updateValueState(),h(this,"options-updated",{options:e,value:this.value||""})}_updateValueState(){this._selectElement&&(this.multiple?(Array.isArray(this.value)||(this.value="string"==typeof this.value&&this.value?[this.value]:[]),Array.from(this._selectElement.options).forEach((e=>{e&&e.value&&(e.selected=this.value.includes(e.value))}))):void 0!==this.value&&null!==this.value||(this.value=""),this.required&&this.value.length>0&&this.hasError&&this.clearErrorState())}firstUpdated(e){if(super.firstUpdated?.(e),this.options||this.values)this._parsedOptions.length||this._parseOptionsFromAttributes(),this._updateSelectWithParsedOptions();else{const e=Array.from(this.children||[]).filter((e=>e&&!e.hasAttribute("slot"))),t=Array.from(e).filter((e=>e&&e.hasAttribute("selected"))).map((e=>e.value)).filter(Boolean);if(t.length>0)this.multiple?(this.value=[...t],this.selected=t.join(";")):(this.value=t[0],this.selected=t[0]),this.multiple?this._initialSelectedValues=[...t]:this._initialSelectedValues=t[0];else if(this.hasAttribute("value")){const e=this.getAttribute("value");if(this.multiple&&e){const t=e.includes(";")?e.split(";").map((e=>e.trim())).filter(Boolean):[e];this.value=t,this.selected=t.join(";")}else this.value=e,this.selected=e}else if(this.hasAttribute("selected")&&!this.value){const e=this.getAttribute("selected"),t=e?e.split(";").map((e=>e.trim())):[];t.length>0&&(this.multiple?this.value=[...t]:this.value=t[0])}this.updateOptions(e)}if(this.multiple?this._initialSelectedValues&&Array.isArray(this._initialSelectedValues)&&this._initialSelectedValues.length||(this._initialSelectedValues=Array.isArray(this.value)?[...this.value]:[]):void 0===this._initialSelectedValues&&(this._initialSelectedValues=this.value||""),this._updateFormValue(),!this.value&&this._selectElement&&this._selectElement.options.length)for(let e=0;e<this._selectElement.options.length;e++){const t=this._selectElement.options[e];if(!t.disabled&&t.value){this.value=t.value,this._selectElement.value=t.value,this.clearErrorState();break}}setTimeout((()=>{this._syncUIWithValue()}),0)}_updateFormValue(){if(this.name)if(this.multiple&&Array.isArray(this.value)){const e=new FormData;this.value.forEach((t=>{null!=t&&e.append(this.name,t)})),this._internals?.setFormValue(e)}else this._internals?.setFormValue(this.value||"")}_handleInput(e){if(this.disabled)return;const t=this._selectElement;t&&h(this,"input",{value:t.value})}_handleChange(e){if(this.disabled)return;const t=this._selectElement;if(!t)return;let s;s=this.multiple?Array.from(t.selectedOptions||[]).map((e=>e?.value||"")).filter(Boolean):t.value,this.value=s,this.multiple?this.selected=Array.isArray(s)?s.join(";"):"":this.selected=s||"",null!=s&&""!==s&&(!Array.isArray(s)||s.length>0)?this.clearErrorState():(this.validate||this.showErrors)&&this.checkValidity(),this._updateFormValue(),this._internals&&this._selectElement&&this._internals.setValidity(this._selectElement.validity,this._selectElement.validationMessage||"",this._selectElement),this._debouncedDispatchChange(this.value)}_handleFocus(e){this.disabled||h(this,"focus",{target:e.target})}_handleBlur(e){this.disabled||((this.validate||this.showErrors)&&this.checkValidity(),h(this,"blur",{target:e.target}))}checkValidity(){try{const e=this._selectElement;if(!e)return"";try{e.setCustomValidity("")}catch(e){console.warn("Error clearing custom validity:",e)}let t=!0,s="";if(this.required){let i=void 0===this.value||null===this.value||""===this.value||Array.isArray(this.value)&&0===this.value.length;if(!i&&0===e.selectedIndex){const t=e.options[0];!t||t.value&&""!==t.value||(i=!0)}i&&(s=this.errormessage||"Bitte wÃ¤hlen Sie eine Option aus",t=!1)}return t?(this._errorController.clearError(),""):(this._errorController.setError(s),s)}catch(e){return console.error("Error in wm-select checkValidity:",e),""}}clearErrorState(){try{this._errorController.clearError(),h(this,"valid",{value:this.value})}catch(e){console.error("Error in wm-select clearErrorState:",e)}}showError(e){this._errorController.setError(e)}clearError(){this._errorController.clearError()}_synchronizeErrorState(e=""){e?this._errorController.setError(e):this._errorController.clearError(),h(this,this.hasError?"invalid":"valid",{value:this.value,message:e})}_performValidation(){try{if(!this._selectElement)return"";if(this.disabled)return"";if(this.required){let e=void 0===this.value||null===this.value||""===this.value||Array.isArray(this.value)&&0===this.value.length;if(!e){const t=Array.isArray(this.value)?this.value[0]:this.value;Array.from(this._selectElement?.options||[]).some((e=>e.value===t))||(console.warn(`Select has value "${t}" but no matching option exists`),e=!0)}if(e){const e=this.errormessage||"Bitte wÃ¤hlen Sie eine Option aus";return this._errorController.setError(e),e}}return this._errorController.clearError(),""}catch(e){return console.error("Error in Select _performValidation:",e),""}}reset(){try{if(this.multiple)this.value=Array.isArray(this._initialSelectedValues)?[...this._initialSelectedValues]:[];else if(this.value=this._initialSelectedValues||"",!this.value&&this._selectElement&&this._selectElement.options&&this._selectElement.options.length>0)for(let e=0;e<this._selectElement.options.length;e++){const t=this._selectElement.options[e];if(!t.disabled&&t.value){this.value=t.value,this._selectElement.value=t.value;break}}if(this.multiple?this.selected=Array.isArray(this._initialSelectedValues)?this._initialSelectedValues.join(";"):"":!this._initialSelectedValues&&this.value?this.selected=this.value:this.selected=this._initialSelectedValues||"",this._selectElement)if(this.multiple&&Array.isArray(this.value)){Array.from(this._selectElement.options||[]).forEach((e=>{if(e)try{e.selected=this.value.includes(e.value)}catch(e){console.warn("Error setting option selected state during reset:",e)}}))}else try{this.value?this._selectElement.value=this.value:this._selectElement.options&&this._selectElement.options.length>0&&(this._selectElement.selectedIndex=0,this.value=this._selectElement.options[0].value)}catch(e){console.warn("Error setting select value during reset:",e)}this._errorController.clearError(),this._updateFormValue(),h(this,"change",{value:this.value,isReset:!0}),setTimeout((()=>{if(this._selectElement){if(this.multiple&&Array.isArray(this.value)){Array.from(this._selectElement.options||[]).forEach((e=>{if(e)try{e.selected=this.value.includes(e.value)}catch(e){console.warn("Error setting option selected state during reset:",e)}}))}this._selectElement.dispatchEvent(new Event("change",{bubbles:!0}))}}),0)}catch(e){console.error("Error in wm-select reset method:",e)}}formResetCallback(){try{super.formResetCallback?.(),this.reset(),setTimeout((()=>{const e=this.shadowRoot?.querySelector("select");e&&e.dispatchEvent(new Event("change",{bubbles:!0}))}),10)}catch(e){console.error("Error in wm-select formResetCallback:",e)}}updated(e){try{if(super.updated(e),e.has("hasError"))if(this.hasError&&this._selectElement){this._selectElement.setAttribute("aria-invalid","true");const e=this.error||this.errormessage;if(e&&this._selectElement)try{this._selectElement.setCustomValidity(e)}catch(e){console.warn("Error setting custom validity for error state:",e)}}else if(this._selectElement){this._selectElement.removeAttribute("aria-invalid");try{this._selectElement.setCustomValidity("")}catch(e){console.warn("Error clearing custom validity for no-error state:",e)}}e.has("selected")&&this._handleSelectedAttributeChange(),e.has("value")&&!e.has("selected")&&this._handleValuePropertyChange(e.get("value"));const t=e.has("options"),s=e.has("values");if((t||s)&&(this._parseOptionsFromAttributes(),this._updateSelectWithParsedOptions()),e.has("multiple")&&(this.value=this.multiple?Array.isArray(this.value)?this.value:this.value?[this.value]:[]:Array.isArray(this.value)?this.value.length>0?this.value[0]:"":this.value,this._syncUIWithValue()),e.has("disabled")&&this._selectElement&&Array.from(this._selectElement.options).forEach((e=>{if(this.disabled)e.disabled=!0;else{const t=Array.from(this._selectElement.options).indexOf(e),s=this._parseDisabledOptions();e.disabled=t<s.length&&s[t]}})),e.has("disabledoptions")&&!this.disabled&&this._selectElement){const e=this._parseDisabledOptions();Array.from(this._selectElement.options).forEach(((t,s)=>{s<e.length&&(t.disabled=e[s])}))}if(e.has("value")){(!this.required||(this.multiple?Array.isArray(this.value)&&this.value.length>0:!!this.value))&&this.hasError&&this.clearErrorState()}}catch(e){console.error("Error in wm-select updated lifecycle:",e)}}disconnectedCallback(){this._debouncedDispatchChange&&"function"==typeof this._debouncedDispatchChange.cancel&&this._debouncedDispatchChange.cancel(),super.disconnectedCallback?.()}render(){return this._renderElement(t`
			<select
				id="${this._formId}"
				name="${r(this.name)}"
				size="${r(void 0!==this.size?Number(this.size):void 0)}"
				?required=${this.required}
				?multiple=${this.multiple}
				aria-disabled="${r(!!this.disabled||void 0)}"
				@input="${this._handleInput}"
				@blur="${this._handleBlur}"
				@focus="${this._handleFocus}"
				@change="${this._handleChange}"
				?disabled=${this.disabled}
				aria-invalid="${r(!!this.hasError||void 0)}"
				part="select"
				>
			</select>
			<slot style="display: none;"></slot>
		`)}setValue(e,t={}){const s=!1!==t.validate,i=!0===t.silent,l=this.value;return this.multiple?this.value=Array.isArray(e)?[...e]:e?[e]:[]:this.value=void 0!==e?e:"",this.multiple?this.selected=Array.isArray(this.value)?this.value.join(";"):"":this.selected=this.value||"",this._selectElement&&(this.multiple&&Array.isArray(this.value)?Array.from(this._selectElement.options).forEach((e=>{e.selected=this.value.includes(e.value)})):this._selectElement.value=this.value),this._updateFormValue(),s&&!this.disabled&&this._errorController.validate(),i||h(this,"change",{value:this.value,previousValue:l,isProgrammatic:!0}),this.value}setDisabled(e){if(this.disabled=Boolean(e),this._selectElement){const e=this._parseDisabledOptions();Array.from(this._selectElement.options).forEach(((t,s)=>{t.disabled=!!this.disabled||s<e.length&&e[s]}))}this.requestUpdate()}validateField(){return this.checkValidity()}updateUI(){this._selectElement&&(this.multiple&&Array.isArray(this.value)?Array.from(this._selectElement.options).forEach((e=>{e.selected=this.value.includes(e.value)})):this.value&&(this._selectElement.value=this.value)),this.requestUpdate()}_selectedToValue(e){if(!e)return this.multiple?[]:"";const t=e.split(";").map((e=>e.trim()));return this.multiple?t:t[0]||""}_valueToSelected(e){return this.multiple?Array.isArray(e)?e.join(";"):"":e||""}_syncUIWithValue(){if(this._selectElement){if(this.multiple)Array.from(this._selectElement.options).forEach((e=>{e.selected=Array.isArray(this.value)&&this.value.includes(e.value)}));else if(this._selectElement.value=this.value||"",this._selectElement.value!==this.value){const e=Array.from(this._selectElement.options),t=e.find((e=>e.value===this.value));if(t)t.selected=!0;else if(""===this.value&&e.length>0){const t=e.find((e=>!e.value));t?t.selected=!0:this._selectElement.selectedIndex=0}}this._updateFormValue()}}_handleSelectedAttributeChange(){this.hasAttribute("selected")&&(this.value=this._selectedToValue(this.selected),this.multiple?this._initialSelectedValues&&Array.isArray(this._initialSelectedValues)&&this._initialSelectedValues.length||(this._initialSelectedValues=Array.isArray(this.value)?[...this.value]:[]):this._initialSelectedValues||""===this._initialSelectedValues||(this._initialSelectedValues=this.value),this._syncUIWithValue(),h(this,"change",{value:this.value,selected:this.selected,source:"attribute-change"}))}_handleValuePropertyChange(e){this.multiple&&!Array.isArray(this.value)?this.value=this.value?[this.value]:[]:!this.multiple&&Array.isArray(this.value)&&(this.value=this.value.length>0?this.value[0]:"");const t=this._valueToSelected(this.value);this.selected!==t&&(this.selected=t),this._syncUIWithValue();JSON.stringify(this.value)!==JSON.stringify(e)&&h(this,"change",{value:this.value,previousValue:e,source:"property-change"})}}customElements.define("wm-select",d);const m="wm-select";export{d as Select,m as tagName};
