/* @copyright Stadt Wien - Wiener Melange 200 */
const t=t=>class extends t{static properties={...t.properties,_initialValue:{state:!0},defaultValue:{attribute:!1},_componentState:{state:!0},_previousState:{state:!0},disabled:{type:Boolean,reflect:!0},hasError:{type:Boolean,reflect:!0},error:{type:String},validate:{type:Boolean,reflect:!0},showErrors:{type:Boolean,reflect:!0}};static get STATES(){return{INITIAL:"initial",NORMAL:"normal",DISABLED:"disabled",JUST_ENABLED:"enabled",EDITING:"editing",VALIDATING:"validating"}}constructor(){super(),this._componentState=this.constructor.STATES.INITIAL,this._previousState=null,this.disabled=!1,this.hasError=!1,this.error="",this.validate=!1,this.showErrors=!1,this._initialValue="",this.defaultValue="",this._changeState=this._changeState.bind(this),this._updateErrorState=this._updateErrorState.bind(this)}connectedCallback(){super.connectedCallback?.(),this.hasAttribute("value")&&(this._initialValue=this.getAttribute("value")||"",this.defaultValue=this._initialValue),setTimeout((()=>{this._componentState===this.constructor.STATES.INITIAL&&this._changeState(this.constructor.STATES.NORMAL)}),100)}firstUpdated(t){if(super.firstUpdated?.(t),""===this._initialValue&&this.shadowRoot){const t=this._getInputElement();t&&t.value&&(this._initialValue=t.value,this.defaultValue=t.value)}}formResetCallback(){try{super.formResetCallback?.(),"function"==typeof this.reset?this.reset():this._resetToInitialValue(),setTimeout((()=>{const t=this._getInputElement();t&&t.value!==(this.value||"")&&(t.value=this.value||"",t.dispatchEvent(new Event("input",{bubbles:!0})))}),10)}catch(t){console.error(`Error in ${this.tagName} formResetCallback:`,t)}}_resetToInitialValue(){this.value=this._initialValue||"";const t=this._getInputElement();t&&(t.value=this.value),"hasError"in this&&(this.hasError=!1),"error"in this&&(this.error=""),this._internals&&"function"==typeof this._internals.setFormValue&&this._internals.setFormValue(this.value)}_getInputElement(){return this.shadowRoot&&(this.shadowRoot.querySelector("input, select, textarea")||this.shadowRoot.querySelector('[role="textbox"], [role="combobox"]'))||null}_changeState(t,i={}){if(this._componentState===t)return;const a=this._componentState;this._previousState=a,this._componentState=t,e(this,a,t,i)}_handleStateTransition(t,i,a={}){e(this,t,i,a)}_updateErrorState(t){const e=!!t;this.error=t||"",this.hasError=e;const i=this._getFormControlElement();if(i)if(e){i.setAttribute("aria-invalid","true");try{"function"==typeof i.setCustomValidity&&i.setCustomValidity(t)}catch(t){console.warn("Error setting custom validity:",t)}}else{i.removeAttribute("aria-invalid");try{"function"==typeof i.setCustomValidity&&i.setCustomValidity("")}catch(t){console.warn("Error clearing custom validity:",t)}}if(this._internals)try{this._internals.setValidity(e?{customError:!0}:{},t||"",i)}catch(t){console.warn("Error updating form internals:",t)}this.dispatchEvent(new CustomEvent(e?"invalid":"valid",{bubbles:!0,composed:!0,detail:{value:this.value,message:t}}))}_getFormControlElement(){return this.shadowRoot?.querySelector("input, select, textarea")||null}_announceStateChange(t){const e=document.querySelector('[role="status"]');if(!e)return;const i=this.label||this.getAttribute("label")||this.id||"Field";e.textContent=`${i} is now ${t}`,setTimeout((()=>{e.textContent=""}),2e3)}updated(t){if(super.updated?.(t),t.has("disabled")){const e=this.disabled,i=t.get("disabled");this._componentState!==this.constructor.STATES.INITIAL&&(e?this._changeState(this.constructor.STATES.DISABLED):!0===i&&this._changeState(this.constructor.STATES.JUST_ENABLED))}}checkValidity(){if(this._componentState!==this.constructor.STATES.NORMAL)return"";const t=this._performValidation();return this._updateErrorState(t),t}_performValidation(){return this._getFormControlElement()?!this.required||this.value&&""!==this.value?"":this.errormessage||"Dieses Feld ist erforderlich":""}setCustomValidity(t){this._updateErrorState(t)}formDisabledCallback(t){this.disabled!==t&&(this.disabled=t,t||setTimeout((()=>{try{this._updateErrorState("");const t=this._getFormControlElement();t&&void 0!==t.value&&"value"in this&&(t.value=this.value||"")}catch(t){console.warn("Error synchronizing state after enabling form control:",t)}}),0))}};function e(t,e,i,a={}){const s=t.constructor.STATES;i===s.DISABLED?(t._updateErrorState(""),t._announceStateChange("disabled")):i===s.JUST_ENABLED?(t._updateErrorState(""),t._announceStateChange("enabled"),setTimeout((()=>{t._componentState===s.JUST_ENABLED&&t._changeState(s.NORMAL)}),300)):i===s.EDITING?(t._updateErrorState(""),clearTimeout(t._editingTimer),t._editingTimer=setTimeout((()=>{t._componentState===s.EDITING&&t._changeState(s.NORMAL)}),2e3)):i===s.VALIDATING&&setTimeout((()=>{t._componentState===s.VALIDATING&&t._changeState(s.NORMAL)}),100)}export{t as FormStateManager};
