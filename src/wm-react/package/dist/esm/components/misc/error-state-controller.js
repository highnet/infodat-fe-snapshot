/* @copyright Stadt Wien - Wiener Melange 200 */
import{dispatchCustomEvent as t}from"./utils.js";import{errorTracker as s}from"./error-tracking.js";import"../../unsafe-html-4e49b66a.js";import"../../lit-html-34d0b6a8.js";import"../../directive-16e189ed.js";class r{constructor(t){this.host=t,this.errorMessage="",this.hasError=!1,this.previousErrorStates=new Map,this._isValidating=!1,this._pendingErrorMessage="",this._isInitialValidation=!0,this.host.addController(this),setTimeout((()=>{this._isInitialValidation=!1}),500)}hostConnected(){this.host.error&&(this.host.showErrors||this.host.validate)&&(this.errorMessage=this.host.error,this.hasError=!0)}hostUpdated(t){t&&"function"==typeof t.has&&(t.has("error")&&this.host.error!==this.errorMessage&&this.setError(this.host.error||""),(t.has("showErrors")&&this.host.showErrors||t.has("validate")&&this.host.validate)&&this._pendingErrorMessage&&(this.setError(this._pendingErrorMessage),this._pendingErrorMessage=""))}setError(t,r={}){const i=this.hasError;this.errorMessage=t||"",this.hasError=!!t,this.host.error=this.errorMessage,this.host.hasError=this.hasError;const e=!this._isInitialValidation||this.host.showErrors||this.host.validate;this._synchronizeDOM(!e&&this.hasError),!this.hasError||!this.host.id||i&&i===this.hasError||s.trackError(this.host.id,{message:this.errorMessage,summaryMessage:this.host.getAttribute("summary-errormessage")||this.errorMessage,nodeName:this.host.nodeName}),e?(r.announceToScreenReader&&this.hasError&&this._announceError(),r.focusElement&&this.hasError&&this._focusElement()):this.hasError&&(this._pendingErrorMessage=t)}clearError(){this._pendingErrorMessage="",this.setError("")}validate(){if(this._isValidating)return!this.hasError;try{this._isValidating=!0;const t=!this._isInitialValidation||this.host.showErrors||this.host.validate;let s;if("function"==typeof this.host._defineErrorMessages&&this.host._defineErrorMessages(),"function"==typeof this.host._validateWithoutController)s=this.host._validateWithoutController();else if("function"==typeof this.host._performValidation)s=this.host._performValidation();else if("function"==typeof this.host.checkValidity)s=this.host.checkValidity();else{const t=this._getFormControlElement();s=t&&!t.validity.valid?t.validationMessage:""}return t?this.setError(s,{announceToScreenReader:!this._isInitialValidation&&!!s}):s&&(this._pendingErrorMessage=s,this._synchronizeDOM(!0)),!s}finally{this._isValidating=!1,(this.host.validate||this.host.showErrors)&&(this._isInitialValidation=!1)}}_synchronizeDOM(t=!1){const s=this._getFormControlElement();if(s)if(this.hasError){if(t||s.setAttribute("aria-invalid","true"),"function"==typeof s.setCustomValidity){if(!s.validationMessage||t)try{s.setCustomValidity(this.errorMessage)}catch(t){console.warn("Error setting custom validity:",t)}}}else{s.removeAttribute("aria-invalid");try{"function"==typeof s.setCustomValidity&&s.setCustomValidity("")}catch(t){console.warn("Error clearing custom validity:",t)}}this._updateFormValidity(),t||this._dispatchEvents()}_updateFormValidity(){if(this.host._internals)try{this.hasError?this.host._internals.setValidity({customError:!0},this.errorMessage,this._getFormControlElement()||void 0):this.host._internals.setValidity({})}catch(t){console.warn("Error updating form internals validity:",t)}}_dispatchEvents(){t(this.host,this.hasError?"invalid":"valid",{value:this.host.value,message:this.errorMessage||""})}_getFormControlElement(){return"function"==typeof this.host._getFormControlElement?this.host._getFormControlElement():this.host._item||this.host.selectElement||this.host.shadowRoot?.querySelector('input, select, textarea, [role="switch"]')}_focusElement(){const t=this._getFormControlElement();t&&"function"==typeof t.focus&&setTimeout((()=>{t.focus()}),0)}_announceError(){let t=document.getElementById("error-announcer");t||(t=document.createElement("div"),t.id="error-announcer",t.setAttribute("aria-live","assertive"),t.setAttribute("aria-atomic","true"),t.className="wm-h-vh",document.body.appendChild(t)),t.textContent=this.errorMessage,setTimeout((()=>{t.textContent=""}),1e3)}}export{r as ErrorStateController};
