/* @copyright Stadt Wien - Wiener Melange 200 */
import{errorTracker as r}from"./error-tracking.js";import{dispatchCustomEvent as e}from"./utils.js";import"../../unsafe-html-4e49b66a.js";import"../../lit-html-34d0b6a8.js";import"../../directive-16e189ed.js";class t{constructor(r,e){this.host=r,this.formControlRegistry=e,this.errors=[],this.previousErrors=[],this.hasValidationError=!1}validate(){this.previousErrors=[...this.errors],this.errors=[],r.reset();const e=new Set,t=new Set;try{const r=this.host._fields||[],o=Array.from(this.host.querySelectorAll("wm-form-group")),i=new Set(o.map((r=>r.id)).filter(Boolean)),s=Array.from(r),a=new Map;s.forEach(((r,e)=>{r&&r.id&&a.set(r.id,e)}));const l=r=>r&&a.has(r)?a.get(r):Number.MAX_SAFE_INTEGER;return s.forEach((r=>{r&&!0!==r.disabled&&!r.hasAttribute("disabled")&&"wm-select"===r.tagName.toLowerCase()&&"function"==typeof r.checkValidity&&r.checkValidity()})),s.forEach((r=>{r&&!0!==r.disabled&&!r.hasAttribute("disabled")&&("showErrors"in r&&(r.showErrors=!0),"_hasInteracted"in r&&(r._hasInteracted=!0))})),this._validateFormGroups(o,e,t,l),this._validateFields(r,e,t,i,l),this.errors.sort(((r,e)=>(r.domPosition||0)-(e.domPosition||0))),o.forEach((r=>{r&&"function"==typeof r.validateGroup&&r.validateGroup()})),this._checkPreviouslyInvalidFields(),this.hasValidationError=this.errors.length>0,!this.hasValidationError}catch(r){return console.error("Error in form validation:",r),!1}}_checkPreviouslyInvalidFields(){this.previousErrors.forEach((r=>{if(!this.errors.some((e=>e.id===r.id))){const t=this.host.querySelector(`#${r.id}`);t&&(t._errorController?t._errorController.clearError():"function"==typeof t.clearError&&t.clearError(),e(t,"valid",{id:t.id,value:t.value}))}}))}_validateFormGroups(r,e,t,o){r.forEach((r=>{if(!r||!r.id)return;if(r.disabled||r.hasAttribute("disabled"))return;if(e.has(r.id))return;"_hasInteracted"in r&&(r._hasInteracted=!0),"showErrors"in r&&(r.showErrors=!0);let i="",s="";if("function"==typeof r.validateGroup){const e=r.validateGroup();e&&"object"==typeof e?(i=e.message,s=e.firstInvalidFieldId,e.invalidFields&&Array.isArray(e.invalidFields)?e.invalidFields.forEach((r=>{r&&r.id&&t.add(r.id)})):Array.from(r.querySelectorAll("[id]")).forEach((r=>{r&&r.id&&t.add(r.id)}))):e&&(i=e)}else"function"==typeof r.checkValidity&&(i=r.checkValidity());if(i){e.add(r.id);const t=r.getAttribute("summary-errormessage")||i;let a=r.id;s&&s!==r.id&&(a=s,e.add(s)),this.errors.push({nodeName:r.nodeName,id:a,originId:r.id,msg:i,summaryMsg:t,isGroupError:!0,domPosition:o(a)})}}))}_validateFields(r,e,t,o,i){r.forEach((r=>{if(!r||!r.id)return;if(r.disabled||r.hasAttribute("disabled"))return;if(e.has(r.id))return;if(t.has(r.id))return void("function"==typeof r.checkValidity?r.checkValidity():"function"==typeof r._validateWithoutController&&r._validateWithoutController());const s=r.closest("wm-form-group");if(s&&s.id&&o.has(s.id))"function"==typeof r.checkValidity?r.checkValidity():"function"==typeof r._validateWithoutController&&r._validateWithoutController();else if("_hasInteracted"in r&&(r._hasInteracted=!0),"wm-select"===r.tagName.toLowerCase()){let t=!1;const o=r.hasAttribute("multiple");if("value"in r&&(o&&Array.isArray(r.value)?t=r.value.length>0:o||(t=void 0!==r.value&&null!==r.value&&""!==r.value)),o&&!t){t=r.querySelectorAll("option[selected]").length>0}let s="";if(r.required&&t?(r._errorController?r._errorController.clearError():"function"==typeof r.clearError&&r.clearError(),r.removeAttribute("haserror"),s=""):"function"==typeof r.checkValidity&&(s=r.checkValidity()),s){e.add(r.id);const t=r.getAttribute("summary-errormessage")||s;this.errors.push({nodeName:r.nodeName,id:r.id,msg:s,summaryMsg:t,domPosition:i(r.id)})}}else{let t="";if("function"==typeof r.checkValidity?t=r.checkValidity():"function"==typeof r._validateWithoutController&&(t=r._validateWithoutController()),t){e.add(r.id);const o=r.getAttribute("summary-errormessage")||t;this.errors.push({nodeName:r.nodeName,id:r.id,msg:t,summaryMsg:o,domPosition:i(r.id)})}}}))}setErrors(r){return this.previousErrors=[...this.errors],this.errors=Array.isArray(r)?r:[],this.hasValidationError=this.errors.length>0,this.errors}getErrors(){return this.errors}reset(t=!1){this.previousErrors=t?[...this.errors]:[],this.errors=[],this.hasValidationError=!1,r.reset();try{(this.host._fields||[]).forEach((r=>{r&&(r._errorController&&r._errorController.clearError(),r.hasAttribute("haserror")&&r.removeAttribute("haserror"),"wm-select"===r.tagName.toLowerCase()&&("function"==typeof r.clearError&&r.clearError(),r.removeAttribute("haserror")))}))}catch(r){console.error("Error during form control error state reset:",r)}return e(this.host,"validation-reset",{}),!0}hostConnected(){}hostDisconnected(){}}export{t as FormValidationController};
