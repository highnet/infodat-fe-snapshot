/* @copyright Stadt Wien - Wiener Melange 200 */
import"../../lit-element-8d7b5fe2.js";import{x as t}from"../../lit-html-34d0b6a8.js";import{f as e}from"../../form-item.styles-b671e7a9.js";import{f as i}from"../../form.styles-3cb5bbeb.js";import{FormItem as s}from"./form-item.js";import{dispatchCustomEvent as r,removeEmptyFieldsFromObject as n}from"./utils.js";import{e as o}from"../../class-map-b15037ef.js";import{n as h}from"../../when-741bb8d9.js";import"../../unsafe-html-4e49b66a.js";import{FormStateManager as a}from"./form-state-manager.js";import{validateInput as l}from"./formValidation.js";import{g as d}from"../../wiener-melange.bundle.min-ae18d627.js";import{SharedInfoMixin as c}from"./shared-info.js";import"./form-wrapper.js";import"./slot.js";import"./error-state-controller.js";import"./error-tracking.js";import"../../directive-16e189ed.js";import"../../if-defined-d257cee1.js";const m=new CSSStyleSheet;m.replaceSync(d);const p=d=>{const p=c(a(s(d)));class u extends p{static properties={announcementText:{type:String},hideMaxlength:{type:Boolean},maxlength:{type:Number},placeholder:{type:String},search:{type:String,reflect:!0},size:{type:String},filter:{type:Boolean},_highlightedOptionID:{type:String},maxlengthText:{type:String},info:{type:String},_infoOpen:{type:Boolean},validate:{type:Boolean,reflect:!0},showErrors:{type:Boolean,reflect:!0}};static styles=[m,i,e];get _output(){return document.querySelector('[role="status"]')??null}constructor(){super(),this.announcementText="Suchvorschläge werden angezeigt. Verwenden Sie Pfeiltasten um zu navigieren",this.maxlength=void 0,this.placeholder=void 0,this.search=void 0,this.size=void 0,this.filter=!1,this.hideMaxlength=!1,this._highlightedOptionID=void 0,this.maxlengthText="Es sind noch {remaining} Zeichen verfügbar",this.patternMismatchMessage="Bitte geben Sie einen gültigen Wert ein",this.info=void 0,this._infoOpen=!1,this.value="",this.validate=!1,this.showErrors=!1}connectedCallback(){super.connectedCallback(),this._addEvents();const t=()=>{if(this._item){let t=!1;this._item.addEventListener("input",(e=>{if(!t)try{t=!0,(this.validate||this.showErrors)&&this._errorController.validate()}finally{t=!1}})),this._item.addEventListener("invalid",(e=>{if(e.preventDefault(),!t)try{t=!0,this._errorController.validate()}finally{t=!1}}))}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}updated(t){super.updated(t),t.has("_optionItems")&&(this._selectedOption=-1,this._setAriaSelected(null)),t.has("setvalue")&&setTimeout((()=>{const t=this.shadowRoot.querySelector(`[role="option"][value="${this.setvalue}"]`);t&&this._selectOption(t)}),300),t.has("error")&&this.error&&this._defineErrorMessages()}_setAriaSelected(t){this.shadowRoot.querySelector('[aria-selected="true"]')&&this.shadowRoot.querySelector('[aria-selected="true"]').setAttribute("aria-selected",!1),t&&t.setAttribute("aria-selected",!0)}_handleInput(t){if(this._optionSelected)return t.preventDefault(),void(this._optionSelected=!1);this.disabled||(this.value=t.target.value??"",r(this,"input",{value:this.value,target:t.composedPath()[0]}),(this.validate||this.showErrors)&&this._errorController.validate(),"combobox"===this._originalType&&(this.showOptions(),this._filterOptions(t)))}_filterOptions(t){if(this.filter){this.showOptions();const e=structuredClone(this._originalOptionItems);this._optionItems=e.filter((e=>{const i=t.target.value.toLowerCase();let s=!1;return e.children.length?e.children=e.children.filter((t=>(t.text.toLowerCase().indexOf(i)>-1&&(s=!0),t.text.toLowerCase().indexOf(i)>-1))):e.text.toLowerCase().indexOf(i)>-1&&(s=!0),s}))}}_addEvents(){this.addEventListener("keydown",(t=>{if("INPUT"===t.composedPath()[0].nodeName&&this._renderdOptions.length&&("ArrowUp"===t.code&&(t.preventDefault(),this._selectedOption--),"ArrowDown"===t.code&&(t.preventDefault(),this._selectedOption++),"ArrowUp"!==t.code&&"ArrowDown"!==t.code||(this.showOptions(),this._selectedOption===this._renderdOptions.length&&(this._selectedOption=0),this._selectedOption<0&&(this._selectedOption=this._renderdOptions.length-1),this._markOption(this._selectedOption)),"Enter"===t.code&&this._selectedOption>-1)){const e=this._renderdOptions[this._selectedOption];"A"!==e.nodeName?(t.preventDefault(),this._selectOption(e)):e.click()}"Tab"===t.code&&this._showOptions&&this.hideOptions(!1),"Escape"===t.code&&(this._optionItems&&this._optionItems.length>0?(this.hideOptions(),this._cancelSearch()):this._input.blur())})),this.addEventListener("click",(t=>{t.composedPath()[0].closest('[role="option"]')&&(t.preventDefault(),this._selectOption(t.composedPath()[0]))})),document.addEventListener("click",this._clickOutSide.bind(this)),setTimeout((()=>{this._item&&this._item.addEventListener("input",(()=>{this._defineErrorMessages(),this._internals.setValidity(this._item.validity,this._item.validationMessage,this._item),this.validate&&this.checkValidity()}))}),0)}_markOption(t){this._setAriaSelected(this._renderdOptions[t]),this._highlightedOptionID=this._renderdOptions[t].id,t>5&&this._renderdOptions[t].scrollIntoView(!1),this._optionSelected=!1}_clickOutSide(t){t.target.closest("wm-input")!==this&&(this.search?this._searchVisible&&this._toggleSearch():this._showOptions&&this.hideOptions(!1))}hideOptions(t=!0){if(this._showOptions=!1,t){const t=this.shadowRoot?.querySelector("input");t&&t.focus()}this._selectedOption=-1}showOptions(){this._showOptions||this._announceOptions(),this._showOptions=!0}_announceOptions(){this._output?(this._output.textContent=this.announcementText,setTimeout((()=>{this._output.textContent=""}),2e3)):console.error('Live region <div role="status" class="wm-h-vh"></div> fehlt im Dokument.')}_toggleOptions(){this._showOptions=!this._showOptions}_selectOption(t){const e=t.closest('[role="option"]');if(!e.getAttribute("value"))return void this.hideOptions(!1);this._optionSelected=!0,this._setAriaSelected(e),this._value=e.getAttribute("value")||e.textContent.trim(),this.value=e.textContent.trim(),this._item&&this._item.setCustomValidity(""),this.error="",this.hasError=!1,"function"==typeof this.clearError&&this.clearError();const i=n({text:e.querySelector(".text").textContent.trim(),value:e.getAttribute("value"),id:e.getAttribute("id"),row2:e.dataset.row2,row3:e.dataset.row3});r(this,"input-selected",{data:i}),this.hideOptions(!1)}_cancelSearch(){this._selectedOption=-1,this._optionItems=this._originalOptionItems,this._setAriaSelected(null);const t=this.shadowRoot?.querySelector("input");t&&(t.value="",this.value=""),r(this,"search-cancelled",{value:""}),this.requestUpdate()}_renderElement(e){const i={"wm-h-vh":this.hideMaxlength};let s="";if(this.maxlength&&this.value){const t=this.maxlength-this.value.length;s=this.maxlengthText.replace("{remaining}",t)}return this._renderItem(t`
				${e}
				<div role="status" ?hidden="${!this.maxlength}" class="${o(i)} max-characters">
					${s}
				</div>
				${h(this.hasInfo,(()=>this._renderInfoButton()))}
				${h(this.hasInfo,(()=>this._renderInfoText()))}
			`)}_defineErrorMessages(){if(!this._item)return;if(this._item.validity.valid)return void this._item.setCustomValidity("");const t={valueMissing:this.requiredMessage||"Dieses Feld ist erforderlich",typeMismatch:this.typeMismatchMessage||"Bitte geben Sie einen gültigen Wert ein",patternMismatch:this.patternMismatchMessage||"Bitte geben Sie einen Wert im erforderlichen Format ein",tooLong:this.tooLongMessage||`Maximal ${this.maxlength} Zeichen erlaubt`,tooShort:this.tooShortMessage||`Mindestens ${this.minlength} Zeichen erforderlich`,rangeOverflow:this.rangeOverflowMessage||`Wert muss kleiner oder gleich ${this.max} sein`,rangeUnderflow:this.rangeUnderflowMessage||`Wert muss größer oder gleich ${this.min} sein`,badInput:this.badInputMessage||"Bitte geben Sie einen gültigen Wert ein",stepMismatch:this.stepMismatchMessage||"Bitte geben Sie einen gültigen Wert ein",customError:this._item.validationMessage||"Dieses Feld ist ungültig"};for(const[e,i]of Object.entries(t))if(this._item.validity[e])return void this._item.setCustomValidity(i);this._item.validity.valid||this._item.setCustomValidity(this.errormessage||"Bitte geben Sie einen gültigen Wert ein")}_handleValidation(){if(!this._isValidating)try{this._isValidating=!0,this._defineErrorMessages();let t="";this._item&&!this._item.checkValidity()&&(t=this._item.validationMessage||this.errormessage||"Bitte geben Sie einen gültigen Wert ein"),this._synchronizeErrorState(t)}finally{this._isValidating=!1}}clearErrorState(){this._synchronizeErrorState("")}_synchronizeErrorState(t=""){if(this.hasError=!!t,this.error=t,this._item)if(t){this._item.setAttribute("aria-invalid","true");try{this._item.setCustomValidity(t)}catch(t){console.warn("Error setting custom validity:",t)}}else{this._item.removeAttribute("aria-invalid");try{this._item.setCustomValidity("")}catch(t){console.warn("Error clearing custom validity:",t)}}if(this._internals)try{t?this._internals.setValidity({customError:!0},t,this._item||void 0):this._internals.setValidity({},"",this._item||void 0)}catch(t){console.warn("Error updating form internals validity:",t)}r(this,this.hasError?"invalid":"valid",{value:this.value,message:t})}_performValidation(){const t=this._getInputElement();return t?(this._defineErrorMessages(),t.validity&&!t.validity.valid?t.validationMessage:l(t,{value:this.value,required:this.required,pattern:this.pattern,validator:this.validator,errormessage:this.errormessage||"Bitte geben Sie einen gültigen Wert ein"})):""}_getFormControlElement(){return this._item||this._getInputElement()}}return u};export{p as FormText};
